#!/bin/bash
#SBATCH --job-name={{job_name}}
#SBATCH --time={{time}}
#SBATCH --cpus-per-task={{cpus}}
#SBATCH --mem={{mem}}
#SBATCH --gres=gpu:{{gpus}}
#SBATCH --output={{output_path}}
#SBATCH --array=0-{{array_max}}
{% if partition %}#SBATCH --partition={{partition}}
{% endif %}{% if account %}#SBATCH --account={{account}}
{% endif %}{% if constraint %}#SBATCH --constraint={{constraint}}
{% endif %}
set -euo pipefail

mkdir -p "$(dirname "{{output_path}}")"

declare -a COMMANDS=(
{{commands_block}}
)

export CMD="${COMMANDS[$SLURM_ARRAY_TASK_ID]}"
echo "[$(date -Iseconds)] Running: $CMD"

if command -v zsh >/dev/null 2>&1; then
  zsh -lic 'micromamba run -n {{env_name}} bash -lc '\''export CPATH="$CONDA_PREFIX/include${CPATH:+:$CPATH}" LIBRARY_PATH="$CONDA_PREFIX/lib${LIBRARY_PATH:+:$LIBRARY_PATH}"; for _d in "$CONDA_PREFIX"/lib/python*/site-packages/nvidia/*/lib; do [ -d "$_d" ] && export LD_LIBRARY_PATH="${_d}${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"; done; cd "{{repo_cwd}}" && {{env_exports}} eval "$CMD"'\'''
else
  echo "zsh not found (required)" >&2
  exit 1
fi
